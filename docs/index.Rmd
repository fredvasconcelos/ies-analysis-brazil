---
title: "Educational Institutions Evaluation in Brazil"
author: "Fred Vasconcelos"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
number_sections: true
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

# ETL

## Load libraries

```{r}
library(tidyverse)
library(rstatix)
library(ggplot2)
```


## Load data

We create a list of data frames for faster de creation of the data.

```{r, echo=FALSE}
file_paths <- fs::dir_ls("/home/fredvasconcelos/Documentos/educacao/alunos/2009_2021/")

#df_2021 <- read.csv('/home/fredvasconcelos/Documentos/educacao/alunos/2009_2021/cursos_2021.CSV', sep = ';', encoding = 'latin1')

```

```{r}
listed_df <- file_paths %>%
  map(function (path) {
    read.csv(path, sep = ';', encoding = 'latin1')
  }) %>%
  tibble() 
```

## Feature enginering

The data frames don't have information about Regions and States of Brazil because. We get this information with the *IES CODE* in the **IES DATABASE**.

```{r, echo=F}
regions_states <- read.csv('/home/fredvasconcelos/Documentos/educacao/ies/ies_2021.CSV', sep = ';', encoding = 'latin1') %>%
  select(CO_IES, NO_UF = NO_UF_IES, NO_REGIAO = NO_REGIAO_IES) %>%
  janitor::clean_names()
```

## View data frame structure

```{r}
listed_df %>%
  unnest(cols = '.') %>%
  head()
```

## Describe variables

```{r}
listed_df %>%
  unnest(cols = '.') %>%
  skimr::skim()
```

### Create new data frames - profile students

```{r}
students <- listed_df %>%
  unnest(cols = '.') %>% # unlist and merge data.frames
  janitor::clean_names() %>%
  select(co_ies, nu_ano_censo, no_regiao, no_uf, starts_with('qt_in')) %>%
  right_join(regions_states, by = c('co_ies', 'no_regiao', 'no_uf')) %>%
  group_by(nu_ano_censo, no_regiao, no_uf) %>%
  summarise_all(sum, na.rm = T) %>%
  ungroup()
```

# Data analysis

## Time Series

### Students by time - Brazil

```{r}
head(students)
```

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data) %>%
  summarise_at(c('qt_ing_fem', 'qt_ing_masc'), sum) %>%
  gather('var', 'value', 2:3) %>%
  ggplot(aes(x = data, 
             y = value,
             linetype = factor(var, 
                        labels = c('Female', 'Male')),
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_smooth(method = 'loess', col = 'black') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = guide_legend('Sex'),
         linetype = guide_legend('Sex')) +
  xlab('') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = "K", scale = 1e-3, big.mark = '.'),
                     breaks = seq(0,1500000, by = 250000)) +
  ggtitle('Number of Students by sex')
```

### Students by time - Regions

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data, no_regiao) %>%
  summarise_at(c('qt_ing_fem', 'qt_ing_masc'), sum) %>%
  gather('var', 'value', 3:4) %>%
  ggplot(aes(x = data, 
             y = value,
             linetype = factor(var, 
                        labels = c('Female', 'Male')),
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_smooth(method = 'loess', col = 'black') +
  facet_wrap(~ no_regiao, scales = 'free_y') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = guide_legend('Sex'),
         linetype = guide_legend('Sex')) +
  xlab('') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " K", scale = 1e-3)) +
  ggtitle('Number of Students by sex and Region')
```

### Students by time - States

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data, no_uf) %>%
  summarise_at(c('qt_ing_fem', 'qt_ing_masc'), sum) %>%
  gather('var', 'value', 3:4) %>%
  ggplot(aes(x = data, 
             y = value,
             linetype = factor(var, 
                        labels = c('Female', 'Male')),
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_smooth(method = 'loess', col = 'black') +
  facet_wrap(~ no_uf, scales = 'free_y') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = guide_legend('Sex'),
         linetype = guide_legend('Sex')) +
  xlab('') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " K", scale = 1e-3)) +
  ggtitle('Number of Students by sex and States')
```

### Statistical tests

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data) %>%
  summarise_at(c('qt_ing_fem', 'qt_ing_masc'), sum) %>%
  gather('var', 'value', 2:3) %>%
  lm(data = ., value ~ data + var) %>%
  performance::check_model()
```

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data) %>%
  summarise_at(c('qt_ing_fem', 'qt_ing_masc'), sum) %>%
  gather('var', 'value', 2:3) %>%
  lm(data = ., value ~ data + var) %>%
  performance::model_performance() 
```

### Students by ethnic group - Brazil

```{r}
students %>%
  mutate(data = zoo::as.yearmon(nu_ano_censo)) %>%
  group_by(data) %>%
  summarise_at(c('qt_ing_branca', 'qt_ing_preta', 'qt_ing_indigena',
                 'qt_ing_parda', 'qt_ing_amarela', 'qt_ing_cornd'), sum) %>%
  gather('var', 'value', 2:7) %>%
  mutate(var = case_when(var == 'qt_ing_branca' ~ 'White',
                         var == 'qt_ing_preta' ~ 'Black',
                         var == 'qt_ing_indigena' ~ 'Indigenous',
                         var == 'qt_ing_parda' ~ 'Brown', 
                         var == 'qt_ing_amarela' ~ 'Asian', 
                         var == 'qt_ing_cornd' ~ 'Not\nDefined')) %>%
  ggplot(aes(x = data, 
             y = value,
             linetype = var,
             fill = var)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_smooth(method = 'loess', col = 'black') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  facet_wrap( ~ var, scales = 'free_y') +
  guides(fill = guide_legend('Sex'),
         linetype = guide_legend('Sex')) +
  xlab('') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = "K", scale = 1e-3, big.mark = '.')) +
  ggtitle('Number of Students by sex')
```

