---
title: "Educational Institutions Evaluation in Brazil"
author: "Fred Vasconcelos"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
number_sections: true
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```

# ETL

## Load libraries

```{r}
library(tidyverse)
library(rstatix)
library(ggplot2)
```


## Load data

We create a list of data frames for faster de creation of the data.

```{r, echo=FALSE}
file_paths <- fs::dir_ls("/home/fredvasconcelos/Documentos/educacao/alunos/2009_2021/")

df_2021 <- read.csv('/home/fredvasconcelos/Documentos/educacao/alunos/2009_2021/cursos_2021.CSV', sep = ';', encoding = 'latin1')

```

```{r}
listed_df <- file_paths %>%
  map(function (path) {
    read.csv(path, sep = ';', encoding = 'latin1')
  }) %>%
  tibble() 
```

## Merge data frames

```{r}
df_cursos <- listed_df %>%
  unnest(cols = '.')
```

## View data frame structure

```{r}
head(df_cursos)
```

## Describe variables

```{r}
skimr::skim(df_cursos)
```

## Cleaning data frame

```{r}
df_cursos <- df_cursos %>%
  janitor::clean_names() %>%
  mutate_if(is.character, ~ str_to_lower(str_trim(abjutils::rm_accent(.)))) # concatenate for apply multiples functions
```

## Feature enginering

The data frames don't have information about Regions and States of Brazil because. We get this information with the *IES CODE* in the **IES DATABASE**.

```{r, echo=F}
regions_states <- read.csv('/home/fredvasconcelos/Documentos/educacao/ies/ies_2021.CSV', sep = ';', encoding = 'latin1') %>%
  select(CO_IES, NO_UF = NO_UF_IES, NO_REGIAO = NO_REGIAO_IES)
```

### Merge Regions and States information

```{r}
df_2021 <- df_2021 %>%
  right_join(regions_states, by = c('CO_IES', 'NO_REGIAO', 'NO_UF'))
```

### Create new data frames - profile students

```{r}
alunos <- df_2021 %>%
  janitor::clean_names() %>%
  select(no_regiao, no_uf, starts_with('qt_in')) %>%
  group_by(no_regiao, no_uf) %>%
  summarise_all(sum, na.rm = T) %>%
  ungroup()
```


# Data analysis

## Students profile

Number of students admitted in Brazil is 3.945.091

### Sex - Brazil

```{r}
alunos %>%
  select(qt_ing_masc, qt_ing_fem) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 1:2) %>%
  ggplot(aes(x = factor(var, 
                        labels = c('Female', 'Male')), 
             y = value, 
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_text(aes(label = scales::label_number(suffix = " M", scale = 1e-6)(value)), 
            position = position_stack(vjust = 0.5),
            col = 'black') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = F) +
  xlab('Sex') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " M", scale = 1e-6),
                     breaks = seq(0,3000000, by = 500000),
                     limits = c(0, 1500000)) +
  ggtitle('Number of Students by sex')

```

### Sex - Regions

```{r}
alunos %>%
  select(no_regiao, qt_ing_masc, qt_ing_fem) %>%
  group_by(no_regiao) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 2:3) %>%
  ggplot(aes(x = factor(var, 
                        labels = c('Female', 'Male')), 
             y = value, 
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_text(aes(label = scales::label_number(suffix = " K", scale = 1e-3)(value)), 
            position = 'dodge',
            col = 'black',
            vjust = -.2) +
  facet_wrap(~ no_regiao) +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = F) +
  xlab('Sex') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " K", scale = 1e-3),
                     breaks = seq(0,1000000, by = 200000),
                     limits = c(0, 800000)) +
  ggtitle('Number of students by sex per Region')
```

### Sex - States

```{r}
alunos %>%
  select(no_uf, qt_ing_masc, qt_ing_fem) %>%
  group_by(no_uf) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 2:3) %>%
  ggplot(aes(x = factor(var, 
                        labels = c('Female', 'Male')), 
             y = value, 
             fill = factor(var, 
                        labels = c('Female', 'Male')))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_text(aes(label = scales::label_number(suffix = " K", scale = 1e-3, accuracy = 0.01)(value)), 
            position = 'dodge',
            col = 'black',
            vjust = -.2) +
  facet_wrap(~ no_uf) +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = F) +
  xlab('Sex') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " K", scale = 1e-3),
                     breaks = seq(0,500000, by = 100000),
                     limits = c(0, 500000)) +
  ggtitle('Number of students by sex per Region')
```

### Ethnicity - Brazil

We use the IBGE's ethnicity classification. Link: <https://educa.ibge.gov.br/jovens/conheca-o-brasil/populacao/18319-cor-ou-raca.html>

```{r}
alunos %>%
  select(qt_ing_branca, qt_ing_preta, qt_ing_parda,
         qt_ing_indigena, qt_ing_cornd, qt_ing_amarela) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 1:6) %>%
  mutate(var = case_when(var == 'qt_ing_branca' ~ 'White',
                         var == 'qt_ing_preta' ~ 'Black', 
                         var == 'qt_ing_parda' ~ 'Brown',
                         var == 'qt_ing_indigena' ~ 'Indigenous', 
                         var == 'qt_ing_cornd' ~ 'Not\nDeclared', 
                         var == 'qt_ing_amarela' ~ 'Asian')) %>%
  ggplot(aes(x = var, 
             y = value, 
             fill = var)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_text(aes(label = scales::label_number(suffix = " K", scale = 1e-3, big.mark = '.')(value)), 
            position = 'dodge',
            vjust = -0.2,
            col = 'black') +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  guides(fill = F) +
  xlab('Ethnic group') +
  scale_y_continuous(name = 'Number of students admitted', 
                     labels = scales::label_number(suffix = " K", scale = 1e-3),
                     breaks = seq(0,1000000, by = 250000),
                     limits = c(0, 1100000)) +
  ggtitle('Number of students by ethnicity')

```

### Ethnicity - Regions

```{r}
alunos %>%
  select(no_regiao, qt_ing_branca, qt_ing_preta, qt_ing_parda,
         qt_ing_indigena, qt_ing_cornd, qt_ing_amarela) %>%
  group_by(no_regiao) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 2:7) %>%
  mutate(var = case_when(var == 'qt_ing_branca' ~ 'White',
                         var == 'qt_ing_preta' ~ 'Black', 
                         var == 'qt_ing_parda' ~ 'Brown',
                         var == 'qt_ing_indigena' ~ 'Indigenous', 
                         var == 'qt_ing_cornd' ~ 'Not\nDeclared', 
                         var == 'qt_ing_amarela' ~ 'Asian')) %>%
  ggplot(aes(x = tidytext::reorder_within(var, value, no_regiao), 
             y = value, 
             fill = var)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  tidytext::scale_x_reordered()+
  facet_wrap(~ no_regiao, scales = 'free') +
  scale_y_log10(name = 'Number of students admitted',
                limits = c(1, 1e9)) +
  geom_text(aes(label = scales::label_number(suffix = " K", scale = 1e-3, big.mark = '.', accuracy = 0.01)(value)), 
            position = position_dodge2(width = 0.5),
            hjust = -0.1,
            col = 'black',
            size = 3) +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  guides(fill = F) +
  xlab('Ethnic group') +
  ggtitle('Number of students by ethnicity per Region')
```

## Ethnicity - States

```{r}
alunos %>%
  select(no_uf, qt_ing_branca, qt_ing_preta, qt_ing_parda,
         qt_ing_indigena, qt_ing_cornd, qt_ing_amarela) %>%
  group_by(no_uf) %>%
  summarise_all(sum) %>%
  gather('var', 'value', 2:7) %>%
  mutate(var = case_when(var == 'qt_ing_branca' ~ 'White',
                         var == 'qt_ing_preta' ~ 'Black', 
                         var == 'qt_ing_parda' ~ 'Brown',
                         var == 'qt_ing_indigena' ~ 'Indigenous', 
                         var == 'qt_ing_cornd' ~ 'Not\nDeclared', 
                         var == 'qt_ing_amarela' ~ 'Asian')) %>%
  ggplot(aes(x = tidytext::reorder_within(var, value, no_uf), 
             y = value, 
             fill = var)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  tidytext::scale_x_reordered() +
  geom_text(aes(label = scales::label_number(suffix = " K", scale = 1e-3, big.mark = '.', accuracy = 0.01)(value)), 
            position = position_dodge2(width = 0.5),
            hjust = -0.2,
            col = 'black',
            size = 3) +
  facet_wrap(~ no_uf, scales = 'free') +
  scale_y_log10(name = 'Number of students admitted',
                limits = c(1, 1e9)) +
  ggthemes::scale_fill_ptol() +
  ggthemes::theme_clean() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  guides(fill = F) +
  xlab('Ethnic group') +
  ggtitle('Number of students by ethnicity per State')
```

